<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">

	<title>reveal.js - The HTML Presentation Framework</title>

	<meta name="description" content="A framework for easily creating beautiful presentations using HTML">
	<meta name="author" content="Hakim El Hattab">

	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

	<link rel="stylesheet" href="css/reveal.css">
	<link rel="stylesheet" href="css/theme/black.css" id="theme">

	<!-- Code syntax highlighting -->
	<link rel="stylesheet" href="lib/css/zenburn.css">


	<link rel="stylesheet" href="css/ownstyles.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement( 'link' );
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
		document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>

	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
</head>

<body>
<div class="reveal">
	<div class="slides">

		<section>
			<h1>Clojure on Android</h1>
			<p>
				Nicholas Kariniemi
			</p>
			<img class="normal-image" data-src="img/clojure_android.png" />
			<br/>
			Reaktor 2015.3.19
		</section>

		<section>
			<h3>Why Clojure on Android?</h3>
			<ul>
				<li>Android today: Java 7(ish)</li>
                <li>Functional goodness</li>
				<li>Concurrency features</li>
				<li>Dynamic development</li>
				<li>Java interop</li>
			</ul>
		</section>

		<section>
			OK, so Clojure on Android is awesome. Let's use it!
		</section>

		<section>
			Hello Clojure on Android!
			<pre><code data-trim>
(ns com.android.helloworld.HelloWorld
  (:gen-class
   :extends android.app.Activity
   :exposes-methods {onCreate superOnCreate})
  (:import [android.app Activity]
           [android.os Bundle]))

(defn -onCreate [this #^android.os.Bundle bundle]
  (.superOnCreate this bundle)
  (.setContentView this com.android.helloworld.R$layout/main))
			</code></pre>
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/android_loader.gif" />
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/android_loader.gif" />
		</section>

		<section>
			Startup time is a problem.
		</section>

		<section>
			<h3>What do you think is Clojure's most glaring weakness / blind spot / problem?</h3>
			<p>
				2013 State of Clojure Survey (Chas Emerick)
			</p>
		</section>

		<section>
			<ul style="font-size: 30px;">
				<h3>2013 State of Clojure Survey Responses</h3>
				<li class="fragment">slow start-up time of jvm</li>
				<li class="fragment">JVM Prejudice, I used to have such against Java. JVM startup time still sucks</li>
				<li class="fragment">its usefulness in many potential applications is limited by the jvm's startup time</li>
				<li class="fragment">start up time and deployed package size (these are related, and not just the jvm's fault)</li>
				<li class="fragment">That damn jvm startup time</li>
				<li class="fragment">It's partly because of the JVM, but clojure programs are really slow to start</li>
				<li class="fragment">JVM startup overhead, documentation</li>
				<li class="fragment">JVM bootstrap time</li>
				<li class="fragment">Language runtime bootstrapping takes way too much time, which renders the
					otherwise desirable scripting story impractical.</li>
				<li class="fragment">Startup time for quick scripts (and I'm not a fan of the various 'hot JVM'
					solutions)</li>
			</ul>
		</section>

		<section>
			<p>Alex Miller analysis of 2013 State of Clojure survey:</p>
			<p>
				<span class="fragment highlight-blue">"By far the largest subset of performance-related complaints were about JVM
				startup time. </span>Phil Hagelberg has also reported that this is one of, perhaps the
				highest, complaint of leiningen users as well.... JVM startup time is never going to go away..., but there are likely still things that can be done to decrease
				Clojure loading time or better control the loading of code"
			</p>
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/stackoverflow1.png" />
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/stackoverflow2.png" />
		</section>

		<section data-background="white">
			<p>Responses: How to speed up startup time (1)</p>
			<small>
				<ul>
					<li>David Nolen: Try the client JVM.</li>
				</ul>
			</small>
			<img class="normal-image" data-src="img/stackoverflow_response1.png" />
		</section>

		<section data-background="white">
			<p>Responses: How to speed up startup time (2)</p>
			<small>
				<ul>
					<li>Try the client JVM.</li>
					<li>Try warming up Clojure first.</li>
				</ul>
			</small>
			<img class="normal-image" data-src="img/stackoverflow_response2.png" />
		</section>

		<section data-background="white">
			<p>Responses: How to speed up startup time (3)</p>
			<small>
				<ul>
					<li>Try the client JVM.</li>
					<li>Try AOT compilation.</li>
					<li>Try using a persistent JVM.</li>
				</ul>
			</small>
			<img class="normal-image" data-src="img/stackoverflow_response3.png" />
		</section>

		<section>
			<h1>Conclusion</h1>
			<div class="fragment">Clojure startup time is a huge problem.</div>
			<div class="fragment">The JVM is the cause.</div>
		</section>

		<section>
			<p>What if we just try it ourselves?</p>
		</section>

		<section>
			<h3>Java & Clojure Hello World</h3>
			<small>
					<pre><code data-trim>
// Java hello world
public class Hello {
    public static void main(String[] args){
        System.out.println("Hello world");
    }
}
					</code></pre>

					<pre><code data-trim>
// Clojure hello world
(ns hello.core
  (:gen-class))

(defn -main [& args]
  (println "Hello world"))
					</code></pre>

					<pre><code data-trim>
# Compile
$ javac Hello.java
$ javac -cp .:clojure-1.6.0.jar -Dclojure.compile.path=./ clojure.lang.Compile hello.core
					</code></pre>

					<pre><code data-trim>
# Run
$ time java Hello
$ time java -cp ../../clojure-1.6.0.jar:target/classes hello.core
					</code></pre>
		</section></small>
		<section>
			<h3>Java & Clojure Hello World Run Times</h3>
					<pre><code data-trim>
$ time java Hello
Hello world
0.03user 0.00system 0:00.04elapsed 102%CPU (0avgtext+0avgdata 15444maxresident)k
0inputs+64outputs (0major+4004minor)pagefaults 0swaps
					</code></pre>
			<code data-trim><pre>
$ time java -cp ../../clojure-1.6.0.jar:target/classes hello.core
Hello world
0.99user 0.03system 0:00.80elapsed 128%CPU (0avgtext+0avgdata 66316maxresident)k
0inputs+64outputs (0major+19191minor)pagefaults 0swaps
			</code></pre>
			<div>Java: 0.04 seconds</div>
			<div>Clojure: 0.80 seconds</div>
		</section>

		<section>
			<h4>Note: </h4>
			<ul>
				<li class="fragment">AOT-compiled</li>
				<li class="fragment">Client JVM</li>
				<li class="fragment">Same JVM for Java and Clojure (so persistent JVM wouldn't affect it)</li>
			</ul>
		</section>

		<section>
			<p>But that's just one test!<br/>You can't conclude anything from one little test.</p>
		</section>

		<section data-background="white">
			<p>Desktop (JVM) Clojure Hello World (average of 20 runs)</p>
			<div id="startupJvm" class="diagram" />
		</section>

		<section>
			<p>So... what about my Android?</p>
		</section>

		<section data-background="white">
			Yup. Clojure on Android starts even slower:
			<div id="startupJvmAndDalvik" class="diagram" />
		</section>

		<section>
			<p>But that's Dalvik. I'll use ART!</p>
			<br/>
			<small class="fragment">(Dalvik is the Android virtual machine for versions up to KitKat/4.4. <br />ART is the new virtual machine starting with Lollipop/5.0.)</small>
		</section>

		<section data-background="white">
			<p>ART is a bit faster</p>
			<div id="startupArt" class="diagram"></div>
		</section>

		<section>
			<p>But that's just one device! Other devices might be faster!</p>
		</section>

		<section data-background="white">
			<p>Yes, a bit:</p>
			<div id="startupOtherDevices" class="diagram"></div>
		</section>

		<section>
			<p>But that's just a stupid hello world app. Real apps are different!</p>
		</section>

		<section>
			<section data-background="white">
			<p>Larger apps start even slower:</p>
			Hello benchmark:
			<div id="startupOtherAppsHello" class="diagram" style="height: 30%"></div>
			Dependencies benchmark:
			<div id="startupOtherAppsDependencies" class="diagram" style="height: 30%"></div>
			</section>
            <section>
			<code data-trim><pre>
(ns benchmark.dependencies
  (:gen-class)
  (:require [rx.lang.clojure.core :as rx]
            [rx.lang.clojure.blocking :as rxb]
            [cognitect.transit :as transit]
            clojure.string)
  (import [java.io ByteArrayOutputStream]
          rx.Observable))

(defn to-json [input]
  (let [out (ByteArrayOutputStream. 4096)
        writer (transit/writer out :json)]
    (transit/write writer input)
    (.toString out)))

(def users ["Tom" "Dick" "Harry"])

(defn fetch-users []
  (->> users
       Observable/from
       (rx/drop 1)
       (rx/map clojure.string/lower-case)
       (rx/map (fn [v] {:id 1234 :name v}))
       (rx/map to-json)))

(defn -main [& args]
  (let [users-json (fetch-users)]
    (rxb/doseq [user users-json]
    (println user))))
			</code></pre>
            </section>
		</section>

		<section>
			<h1>Conclusion</h1>
			<div class="fragment">Clojure startup time is a huge problem.</div>
			<div class="fragment"><span style="color: red;">Clojure</span> is the cause.</span></div>
		</section>

		<section>
			<p>Or in other words:</p>
			<h2 class="fragment">Stop calling it JVM startup time, people</h2>
		</section>

		<section>
			<i>"Not everything is awesome"</i>
			<br/>
			- Rich Hickey
			<br/>
			<small>(as quoted by David Nolen)</small>
		</section>

        <section data-background="white">
			<h1 style="color: red;">Why?!?!</h1>
			<img class="normal-image" data-src="img/why_meme.png" />
		</section>

		<section>
			<p>I don't know. Profile it.</p>
		</section>

		<section data-background="white">
			<h4>Clojure Hello World profiled startup</h4>
			<img class="normal-image" data-src="img/clojure_boot_trace.png" />
			<div class="fragment">clojure.core__init? Wat?</div>
		</section>

		<section data-background="white">
			<p>Clojure JVM startup breakdown</p>
			<div id="bootstrappingTimes" class="diagram"></div>
		</section>

		<section data-background="white">
			<p>Clojure Dalvik startup breakdown</p>
			<div id="dalvikBootstrappingTimes" class="diagram"></div>
		</section>

		<section data-background="white">
			<img class="normal-image" data-src="img/clojure_boot_trace_core.png" />
		</section>

		<section>
			<p>clojure/core__init.class</p>
			<small><code><pre>
static {
    // Create Vars and metadata (11/17%)
    __init0();
    __init1();
    __init2();
    __init3();
    // ...intermediate lines omitted
    __init23();

    // (0%)
    Compiler.pushNSandLoader(Class.forName("clojure.core__init").getClassLoader());
    try{
      // Assign Vars and metadata, load external functions (89/83%)
      load();

      // (0%)
      Var.popThreadBindings();
    }
    finally
    {
      // (0%)
      Var.popThreadBindings();
      throw finally;
    }
}
				</code></pre></small>
		</section>

		<section data-background="white">
			<div>__init class files set up namespace vars</div>
			<img class="normal-image" data-src="img/namespace_vars.svg" />

			<p>So if you use a function in your program:</p>
					<pre><code data-trim>
						(cons 1 '(2 3))
					</code></pre>

			<p>It can be grabbed from the runtime namespace like this:</p>
					<pre><code data-trim>
						RT.var("clojure.core", "cons").getRawRoot().invoke(args);
					</code></pre>
		</section>

		<section data-transition="none">
			<p>Why? Clojure is <i>dynamic</i>.</p>
			<ul>
				<li class="fragment current-visible">Dynamic typing</li>
				<li class="fragment"><strike>Dynamic typing</strike>. Yes but no. We're not talking about that.</li>
				<li class="fragment">Dynamic binding</li>
				<li class="fragment">+ <i>reified</i> language constructs</li>
				<li class="fragment">+ dynamic compilation & evaluation</li>
				<li class="fragment">--> Dynamic development (REPL)</li>
			</ul>
			<br />
			<br />
			<blockquote class="fragment">
				Reification: turning a compiler detail into something you can play with at run time
			</blockquote>
		</section>

		<section>
			<p>Clojure is dynamic like this:</p>
					<pre><code data-trim>
hello.core=> (def foo 1)
#'hello.core/foo
hello.core=> (def print-foo (fn [] (println foo)))
#'hello.core/print-foo
hello.core=> (print-foo)
1
nil
hello.core=> (def foo 2)
#'hello.core/foo
hello.core=> (print-foo)
2
					</code></pre>
		</section>

		<section>
			<p>Which can also look like this:</p>
			<small>
					<pre style="width: 100%;"><code class="clojure" style="width: 100%;">user=> (start-system)
Connected to mongo at localhost: grub-dev
Started server on localhost: 3000

user=> system
{:db-name "grub-dev"
 :db #&lt;DBApiLayer grub-dev&gt;
 :db-conn #&lt;MongoClient ...&gt;
 :port 3000
 :stop-server #&lt;clojure.lang.AFunction$1@7ed72ded&gt;,
 :states #&lt;Atom@610863a9:
   [{:tag 0
     :grubs { :grub-167afa69-f812-455a-bb8a-4b819236011a
                {:id "grub-167afa69-f812-455a-bb8a-4b819236011a"
                 :text "Milk"
                 :completed false}}}]&gt;}
user=> (reset! (:states system) [])
[]
user=> system
{ :db-name "grub-dev"
  :db #&lt;DBApiLayer grub-dev&gt;
  :db-conn #&lt;MongoClient ...&gt;
  :port 3000
  :stop-server #&lt;clojure.lang.AFunction$1@7ed72ded&gt;,
  :states #&lt;Atom@610863a9: []&gt;}
					</code></pre></small>
			<br/>
			<small><a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">(Stuart Sierra "Reloaded" workflow)</a></small>
		</section>

		<section>
			<p>So how can we make Clojure <i>fast</i>?</p>
		</section>

		<section>
			<h3>Lean Clojure</h3>
			<ul>
				<li>Basic idea: trade dynamic features for performance</li>
				<li>Oxcart: based on Clojure in Clojure compiler</li>
				<ul><li>Currently compiles a limited subset of Clojure so not discussed here.</li></ul>
				<li>Skummet: based on standard compiler</li>
			</ul>
		</section>

		<section data-background="white">
			<h3>Skummet in one diagram*</h3>
			<div>Clojure:</div>
			<img class="normal-image" style="max-width: 500px;" data-src="img/namespace_vars.svg" />
			<div>Skummet:</div>
			<img class="normal-image" style="max-width: 500px;" data-src="img/namespace_vars_lean.svg" />
		</section>

		<section>
			Does Skummet work?
		</section>

		<section>
			I don't know. Benchmark it.
		</section>

		<section data-background="white">
			<p>Benchmark startup times</p>
			<div id="startupTimesNexus5dalvik" class="diagram-startup"></div>
			<div id="startupTimesNexus5art" class="diagram-startup"></div>
			<div id="startupTimesNexus7dalvik" class="diagram-startup"></div>
			<div id="startupTimesNexus7art" class="diagram-startup"></div>
		</section>

		<section data-background="white">
			<p>Benchmark total times</p>
			<div id="helloBenchmark" class="diagram-benchmark"></div>
			<div id="dependenciesBenchmark" class="diagram-benchmark"></div>
			<div id="binarytreesBenchmark" class="diagram-benchmark"></div>
			<div id="fannkuchreduxBenchmark" class="diagram-benchmark"></div>
			<div id="nbodyBenchmark" class="diagram-benchmark"></div>
			<div id="pidigitsBenchmark" class="diagram-benchmark"></div>
			<div id="spectralnormBenchmark" class="diagram-benchmark"></div>
		</section>

		<section>
			<h3>Conclusions</h3>
			<ul>
				<li class="fragment">Lean Clojure works</li>
				<li class="fragment">...but it's not good enough</li>
			</ul>
		</section>

		<section>
			<h3>Where is Clojure on Android going?</h3>
			Will I ever be able to use Clojure on Android?
			<br/>
			<br/>
			Two paths:
			<ul>
				<li class="fragment">a) Clojure core developers push lean Clojure idea</li>
				<li class="fragment">b) ClojureScript + wrapper framework (React Native?)</li>
			</ul>
		</section>

		<section>
			<h3>Practical takeaways</h3>
			<ul>
				<li class="fragment">Don't use Clojure on Android for startup-sensitive projects</li>
				<li class="fragment">Unused "requires" kill your startup times</li>
			</ul>
		</section>

		<section data-transition="fade">
			<ul style="font-size: 30px;">
				<li>slow start-up time of jvm</li>
				<li>JVM Prejudice, I used to have such against Java. JVM startup time still sucks</li>
				<li>its usefulness in many potential applications is limited by the jvm's startup time</li>
				<li>start up time and deployed package size (these are related, and not just the jvm's fault)</li>
				<li>That damn jvm startup time</li>
				<li>It's partly because of the JVM, but clojure programs are really slow to start</li>
				<li>JVM startup overhead, documentation</li>
				<li>JVM bootstrap time</li>
				<li>Language runtime bootstrapping takes way too much time, which renders the
					otherwise desirable scripting story impractical.</li>
				<li>Startup time for quick scripts (and I'm not a fan of the various 'hot JVM'
					solutions)</li>
			</ul>
		</section>

		<section data-transition="fade">
			<ul style="font-size: 30px;">
				<li>slow start-up time of jvm</li>
				<li>JVM Prejudice, I used to have such against Java. JVM startup time still sucks</li>
				<li>its usefulness in many potential applications is limited by the jvm's startup time</li>
				<li>start up time and deployed package size (these are related, and <span class="highlight">not just the jvm's fault</span>)</li>
				<li>That damn jvm startup time</li>
				<li>It's partly because of the JVM, but clojure programs are really slow to start</li>
				<li>JVM startup overhead, documentation</li>
				<li>JVM bootstrap time</li>
				<li><span class="highlight">Language runtime bootstrapping takes way too much time</span>, which renders the otherwise desirable scripting story impractical.</li>
				<li>Startup time for quick scripts (<span class="highlight">and I'm not a fan of the various 'hot JVM' solutions</span>)</li>
			</ul>
		</section>
	</div>

</div>

<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/lodash.js"></script>
<script src="js/highcharts.js"></script>
<script src="js/highcharts-more.js"></script>
<script src="js/diagrams.js"></script>
<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

	// Full list of configuration options available at:
	// https://github.com/hakimel/reveal.js#configuration
	Reveal.initialize({
		controls: true,
		progress: true,
		history: true,
		center: true,

		transition: 'slide', // none/fade/slide/convex/concave/zoom

		// Optional reveal.js plugins
		dependencies: [
			{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
			{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
			{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
			{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
			{ src: 'plugin/zoom-js/zoom.js', async: true },
			{ src: 'plugin/notes/notes.js', async: true }
		]
	});

</script>

</body>
</html>
